<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>SNIPER V4.0.0 | 全球掃描共振版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #FFD700; font-family: 'Courier New', monospace; overflow: hidden; }
        .gold-border { border: 1px solid #333; transition: all 0.5s; }
        .vp-break-card { 
            border: 2px solid #a855f7; 
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4); 
            background: linear-gradient(145deg, #1e1b4b, #000) !important; 
            z-index: 10;
        }
        .slider-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; }
        .pin-tag { background: #8b5cf6; color: white; padding: 0 4px; border-radius: 2px; font-size: 8px; margin-right: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col">
    <header class="p-4 border-b border-zinc-800 bg-black flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black text-yellow-500 italic">⚡ SNIPER V4.0.0</h1>
            <p id="systemStatus" class="text-[9px] text-zinc-500 uppercase tracking-widest">Radar Ready</p>
        </div>
        
        <div class="flex gap-6 items-center bg-zinc-900/50 p-2 rounded-lg border border-zinc-800">
            <div class="flex flex-col">
                <label class="slider-label">追蹤幣名 (ENTER)</label>
                <input type="text" id="coinSearch" placeholder="例如: DOGE" onkeydown="if(event.key==='Enter') togglePin(this.value)" class="bg-black border border-zinc-700 text-xs px-2 py-1 focus:outline-none focus:border-yellow-500 text-white w-24 rounded">
            </div>
            <div class="flex flex-col text-center">
                <label class="slider-label">資費斜率 <span id="slopeDisp" class="text-yellow-500">-15%</span></label>
                <input type="range" id="slopeThreshold" min="-200" max="0" value="-15" oninput="document.getElementById('slopeDisp').innerText=this.value+'%'; render();" class="w-24 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="flex flex-col text-center">
                <label class="slider-label">MA纏繞 <span id="maDisp" class="text-yellow-500">0.8%</span></label>
                <input type="range" id="maThreshold" min="0.1" max="5" step="0.1" value="0.8" oninput="document.getElementById('maDisp').innerText=this.value+'%'; render();" class="w-24 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
            </div>
            <button onclick="toggleSystem()" id="mainBtn" class="bg-yellow-600 text-black px-6 py-2 font-bold rounded text-xs hover:bg-yellow-400 transition-colors">LAUNCH RADAR</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 p-4 overflow-y-auto bg-zinc-950">
            <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </main>
        
        <aside class="w-72 border-l border-zinc-900 p-4 overflow-y-auto bg-black shrink-0">
            <div class="text-zinc-500 font-bold mb-4 text-[10px] tracking-[0.2em] border-b border-zinc-800 pb-2">RADAR LOGS</div>
            <div id="logs" class="space-y-2 text-[10px] font-mono"></div>
        </aside>
    </div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT'];
    let allSymbols = [], isRunning = false, scanIdx = 0, timer = null;
    let poolResults = [];
    let pinnedSymbols = new Set(); // 儲存追蹤的幣名

    function addLog(msg, type = 'info') {
        const logs = document.getElementById('logs');
        const color = type === 'hit' ? 'text-purple-400 font-bold' : 'text-zinc-600';
        logs.innerHTML = `<div class="${color}">[${new Date().toLocaleTimeString([], {hour12:false})}] > ${msg}</div>` + logs.innerHTML;
        if(logs.children.length > 50) logs.lastChild.remove();
    }

    function togglePin(val) {
        if(!val) return;
        const s = val.toUpperCase().trim().endsWith('USDT') ? val.toUpperCase() : val.toUpperCase() + 'USDT';
        if(pinnedSymbols.has(s)) pinnedSymbols.delete(s);
        else {
            pinnedSymbols.add(s);
            addLog(`已鎖定追蹤標的: ${s}`, 'hit');
        }
        document.getElementById('coinSearch').value = '';
        render();
    }

    function calcMAEntanglement(klines) {
        const closes = klines.map(k => parseFloat(k[4]));
        const getMA = (period) => closes.slice(-period).reduce((a, b) => a + b) / period;
        const ma7 = getMA(7), ma99 = getMA(99), ma200 = getMA(200);
        return ((Math.max(ma7, ma99, ma200) - Math.min(ma7, ma99, ma200)) / Math.min(ma7, ma99, ma200)) * 100;
    }

    async function getFundingSlope(symbol) {
        const res = await fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=${symbol}&limit=2`);
        const data = await res.json();
        if(data.length < 2) return 0;
        return ((parseFloat(data[1].fundingRate) - parseFloat(data[0].fundingRate)) / Math.abs(parseFloat(data[0].fundingRate))) * 100;
    }

    // --- 核心改動：成交量高峰回溯移動止損 ---
    function calcVolPeakStop(klines, price) {
        let maxVol = 0, peakIdx = 0;
        // 找 100 根內的量能頂
        klines.slice(-100).forEach((k, i) => {
            if(parseFloat(k[5]) > maxVol) { maxVol = parseFloat(k[5]); peakIdx = i; }
        });
        const sincePeak = klines.slice(-(100 - peakIdx));
        const atr = sincePeak.reduce((acc, k) => acc + (parseFloat(k[2]) - parseFloat(k[3])), 0) / sincePeak.length;
        return (price - (atr * 1.5)).toFixed(4); // 以高峰後的平均波幅 1.5 倍作為動態止損位
    }

    function checkVP(klines, price) {
        let maxH = 0, hIdx = 0;
        klines.forEach((k, i) => { if(parseFloat(k[2]) > maxH){ maxH = parseFloat(k[2]); hIdx = i; }});
        const rKlines = klines.slice(hIdx);
        if(rKlines.length < 5) return { isBreakout: false, pocH: 0 };
        const lows = rKlines.map(k => parseFloat(k[3])), highs = rKlines.map(k => parseFloat(k[2])), minP = Math.min(...lows), maxP = Math.max(...highs);
        const bins = new Array(20).fill(0), binSize = (maxP - minP) / 20;
        rKlines.forEach(k => {
            const idx = Math.min(19, Math.floor(((parseFloat(k[2])+parseFloat(k[3]))/2 - minP) / binSize));
            bins[idx] += parseFloat(k[5]);
        });
        const pocH = minP + (bins.indexOf(Math.max(...bins)) * binSize) + binSize;
        return { isBreakout: price > pocH, pocH };
    }

    async function scanSymbol(s) {
        try {
            const [kRes, pRes] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=200`),
                fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`)
            ]);
            const klines = await kRes.json(), ticker = await pRes.json(), price = parseFloat(ticker.lastPrice);
            const maGap = calcMAEntanglement(klines), vp = checkVP(klines, price), slope = await getFundingSlope(s);
            const stopLoss = calcVolPeakStop(klines, price);
            
            let score = 0;
            if (vp.isBreakout) score += 40;
            if (maGap < 1) score += 30;
            if (slope < -15) score += 30;

            return { symbol: s, price, vp, maGap, slope, score, stopLoss, isPinned: pinnedSymbols.has(s) };
        } catch (e) { return null; }
    }

    async function loop() {
        if(!isRunning) return;
        // 每輪包含「已追蹤幣種」+「新批次幣種」
        const currentBatch = allSymbols.slice(scanIdx, scanIdx + 5);
        const targets = [...new Set([...pinnedSymbols, ...currentBatch])];
        
        for(let s of targets) {
            const res = await scanSymbol(s);
            if(res) {
                const idx = poolResults.findIndex(p => p.symbol === res.symbol);
                if(idx > -1) poolResults[idx] = res; else poolResults.push(res);
            }
        }
        scanIdx = (scanIdx + 5) >= allSymbols.length ? 0 : scanIdx + 5;
        render();
        timer = setTimeout(loop, 3000);
    }

    function render() {
        const container = document.getElementById('dashboard');
        const slopeThr = parseFloat(document.getElementById('slopeThreshold').value);
        const maThr = parseFloat(document.getElementById('maThreshold').value);
        
        // 渲染邏輯：符合滑動鈕過濾條件 OR 使用者追蹤的標的
        const filtered = poolResults.filter(res => res.isPinned || (res.slope <= slopeThr && res.maGap <= maThr));

        container.innerHTML = filtered.sort((a, b) => b.isPinned - a.isPinned || b.score - a.score).map(res => `
            <div class="p-4 bg-zinc-900 rounded-lg ${res.score >= 70 ? 'vp-break-card' : 'gold-border'} relative">
                ${res.isPinned ? `
                <button onclick="togglePin('${res.symbol}')" class="absolute top-2 right-2 text-zinc-500 hover:text-red-500 text-[10px]">❌ 移除</button>
                ` : ''}
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-black text-white">${res.isPinned ? '<span class="pin-tag">追蹤</span>' : ''}${res.symbol.replace('USDT','')}</span>
                    <span class="text-[10px] bg-black px-2 py-0.5 rounded text-yellow-500">SCORE: ${res.score}</span>
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-[9px] text-zinc-400">
                    <span>價格: <b class="text-zinc-200">${res.price}</b></span>
                    <span>MA纏繞: <b class="${res.maGap < maThr ? 'text-green-400' : ''}">${res.maGap.toFixed(2)}%</b></span>
                    <span>資費斜率: <b class="${res.slope < slopeThr ? 'text-red-400' : ''}">${res.slope.toFixed(1)}%</b></span>
                    <span>POC頂: <b class="text-yellow-600">${res.vp.pocH.toFixed(4)}</b></span>
                </div>
                <div class="mt-2 pt-2 border-t border-zinc-800 flex justify-between items-center">
                    <span class="text-[8px] text-zinc-500 uppercase">移動止損 (VolPeak)</span>
                    <span class="text-green-500 font-bold text-[10px] underline">${res.stopLoss}</span>
                </div>
                <div class="mt-3 flex gap-1">
                    ${res.vp.isBreakout ? '<span class="text-[8px] bg-purple-900 text-purple-200 px-1">VP_BREAK</span>' : ''}
                    ${res.maGap < maThr ? '<span class="text-[8px] bg-blue-900 text-blue-200 px-1">MA_SQZ</span>' : ''}
                </div>
            </div>
        `).join('');
    }

    async function toggleSystem() {
        if(!isRunning) {
            const res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
            const data = await res.json();
            allSymbols = data.symbols.filter(s => s.quoteAsset === 'USDT' && s.status === 'TRADING').map(s => s.symbol).filter(s => !EXCLUDE.includes(s));
            isRunning = true;
            document.getElementById('mainBtn').innerText = "STOP RADAR";
            document.getElementById('mainBtn').className = "bg-red-900 text-white px-6 py-2 font-bold rounded text-xs";
            loop();
        } else {
            isRunning = false;
            document.getElementById('mainBtn').innerText = "LAUNCH RADAR";
            document.getElementById('mainBtn').className = "bg-yellow-600 text-black px-6 py-2 font-bold rounded text-xs";
            clearTimeout(timer);
        }
    }
</script>
</body>
</html>
