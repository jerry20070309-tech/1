<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>SNIPER V4.0.0 | 全球掃描共振版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #FFD700; font-family: 'Courier New', monospace; overflow: hidden; }
        .gold-border { border: 1px solid #333; transition: all 0.5s; }
        .vp-break-card { 
            border: 2px solid #a855f7; 
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4); 
            background: linear-gradient(145deg, #1e1b4b, #000) !important; 
            z-index: 10;
        }
        .slider-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body class="h-screen flex flex-col">
    <header class="p-4 border-b border-zinc-800 bg-black flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black text-yellow-500">⚡ SNIPER V4.0.0</h1>
            <p id="systemStatus" class="text-[9px] text-zinc-500">RADAR IDLE</p>
        </div>
        
        <div class="flex gap-6 items-center bg-zinc-900/50 p-2 rounded-lg border border-zinc-800">
            <div class="flex flex-col">
                <label class="slider-label">搜尋幣名</label>
                <input type="text" id="coinSearch" placeholder="例如: DOGE" oninput="render()" class="bg-black border border-zinc-700 text-xs px-2 py-1 focus:outline-none focus:border-yellow-500 text-white w-24 rounded">
            </div>
            <div class="flex flex-col">
                <label class="slider-label">資費斜率 (<-15%)</label>
                <input type="range" id="slopeThreshold" min="-50" max="0" value="-15" class="w-24 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="flex flex-col">
                <label class="slider-label">量能爆發 (>2.5x)</label>
                <input type="range" id="volThreshold" min="1" max="10" step="0.5" value="2.5" class="w-24 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="flex flex-col">
                <label class="slider-label">MA纏繞 (<0.8%)</label>
                <input type="range" id="maThreshold" min="0.1" max="3" step="0.1" value="0.8" class="w-24 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
            </div>
            <button onclick="toggleSystem()" id="mainBtn" class="bg-yellow-600 text-black px-6 py-2 font-bold rounded text-xs hover:bg-yellow-400 transition-colors">LAUNCH RADAR</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 p-4 overflow-y-auto bg-zinc-950">
            <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                </div>
        </main>
        
        <aside class="w-72 border-l border-zinc-900 p-4 overflow-y-auto bg-black shrink-0">
            <div class="text-zinc-500 font-bold mb-4 text-[10px] tracking-[0.2em] border-b border-zinc-800 pb-2">RADAR LOGS</div>
            <div id="logs" class="space-y-2 text-[10px] font-mono"></div>
        </aside>
    </div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT'];
    let allSymbols = [], isRunning = false, scanIdx = 0;
    let poolResults = [];

    function addLog(msg, type = 'info') {
        const logs = document.getElementById('logs');
        const color = type === 'hit' ? 'text-purple-400 font-bold' : 'text-zinc-600';
        logs.innerHTML = `<div class="${color}">> ${msg}</div>` + logs.innerHTML;
        if(logs.children.length > 50) logs.lastChild.remove();
    }

    function calcMAEntanglement(klines) {
        const closes = klines.map(k => parseFloat(k[4]));
        const getMA = (period) => closes.slice(-period).reduce((a, b) => a + b) / period;
        const ma7 = getMA(7), ma99 = getMA(99), ma200 = getMA(200);
        const max = Math.max(ma7, ma99, ma200);
        const min = Math.min(ma7, ma99, ma200);
        return ((max - min) / min) * 100;
    }

    async function getFundingSlope(symbol) {
        const res = await fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=${symbol}&limit=2`);
        const data = await res.json();
        if(data.length < 2) return 0;
        const f1 = parseFloat(data[0].fundingRate);
        const f2 = parseFloat(data[1].fundingRate);
        return f1 === 0 ? 0 : ((f2 - f1) / Math.abs(f1)) * 100;
    }

    function checkVP(klines, price) {
        let maxH = 0, hIdx = 0;
        klines.forEach((k, i) => { if(parseFloat(k[2]) > maxH){ maxH = parseFloat(k[2]); hIdx = i; }});
        const rKlines = klines.slice(hIdx);
        if(rKlines.length < 5) return { isBreakout: false, pocH: 0 };
        const lows = rKlines.map(k => parseFloat(k[3])), highs = rKlines.map(k => parseFloat(k[2]));
        const minP = Math.min(...lows), maxP = Math.max(...highs), binSize = (maxP - minP) / 20;
        const bins = new Array(20).fill(0);
        rKlines.forEach(k => {
            const idx = Math.min(19, Math.floor(((parseFloat(k[2])+parseFloat(k[3]))/2 - minP) / binSize));
            bins[idx] += parseFloat(k[5]);
        });
        const pocH = minP + (bins.indexOf(Math.max(...bins)) * binSize) + binSize;
        return { isBreakout: price > pocH, pocH };
    }

    async function scanSymbol(s) {
        try {
            const [kRes, pRes] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=200`),
                fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`)
            ]);
            const klines = await kRes.json();
            const ticker = await pRes.json();
            const price = parseFloat(ticker.lastPrice);
            
            const slopeThr = parseFloat(document.getElementById('slopeThreshold').value);
            const volThr = parseFloat(document.getElementById('volThreshold').value);
            const maThr = parseFloat(document.getElementById('maThreshold').value);

            const volRatio = parseFloat(ticker.quoteVolume) / (parseFloat(ticker.quoteVolume) / 2);
            const maGap = calcMAEntanglement(klines);
            const vp = checkVP(klines, price);
            const slope = await getFundingSlope(s);

            let score = 0;
            if (vp.isBreakout) score += 40;
            if (maGap < maThr) score += 30;
            if (slope < slopeThr) score += 30;

            return { symbol: s, price, vp, maGap, slope, volRatio, score, ticker };
        } catch (e) { return null; }
    }

    async function loop() {
        if(!isRunning) return;
        const batch = allSymbols.slice(scanIdx, scanIdx + 6);
        for(let s of batch) {
            const res = await scanSymbol(s);
            if(res) {
                const existing = poolResults.findIndex(p => p.symbol === res.symbol);
                if(existing > -1) poolResults[existing] = res;
                else poolResults.push(res);
                if(res.score >= 70) addLog(`HIT: ${res.symbol} 分數:${res.score}`, 'hit');
            }
        }
        scanIdx = (scanIdx + 6) >= allSymbols.length ? 0 : scanIdx + 6;
        render();
        timer = setTimeout(loop, 3000);
    }

    function render() {
        const container = document.getElementById('dashboard');
        const searchTerm = document.getElementById('coinSearch').value.toUpperCase();
        
        // 加入搜尋過濾邏輯
        const filtered = poolResults.filter(res => 
            res.symbol.replace('USDT', '').includes(searchTerm)
        );

        const sorted = [...filtered].sort((a, b) => b.score - a.score).slice(0, 24);
        
        container.innerHTML = sorted.map(res => `
            <div class="p-4 bg-zinc-900 rounded-lg ${res.score >= 70 ? 'vp-break-card' : 'gold-border'}">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-black text-white">${res.symbol.replace('USDT','')}</span>
                    <span class="text-[10px] bg-black px-2 py-0.5 rounded text-yellow-500">SCORE: ${res.score}</span>
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-[9px] text-zinc-400">
                    <span>價格: <b class="text-zinc-200">${res.price}</b></span>
                    <span>MA纏繞: <b class="${res.maGap < 1 ? 'text-green-400' : ''}">${res.maGap.toFixed(2)}%</b></span>
                    <span>資費斜率: <b class="${res.slope < -10 ? 'text-red-400' : ''}">${res.slope.toFixed(1)}%</b></span>
                    <span>POC頂: <b class="text-yellow-600">${res.vp.pocH.toFixed(4)}</b></span>
                </div>
                <div class="mt-3 flex gap-1">
                    ${res.vp.isBreakout ? '<span class="text-[8px] bg-purple-900 text-purple-200 px-1">VP_BREAK</span>' : ''}
                    ${res.maGap < 1 ? '<span class="text-[8px] bg-blue-900 text-blue-200 px-1">MA_SQZ</span>' : ''}
                </div>
            </div>
        `).join('');
    }

    async function toggleSystem() {
        if(!isRunning) {
            addLog("正在初始化全市場清單...");
            const res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
            const data = await res.json();
            allSymbols = data.symbols
                .filter(s => s.quoteAsset === 'USDT' && s.status === 'TRADING')
                .map(s => s.symbol)
                .filter(s => !EXCLUDE.includes(s));
            
            isRunning = true;
            document.getElementById('mainBtn').innerText = "STOP RADAR";
            document.getElementById('mainBtn').className = "bg-red-900 text-white px-6 py-2 font-bold rounded text-xs";
            document.getElementById('systemStatus').innerText = `RADAR ACTIVE: ${allSymbols.length} PAIRS`;
            loop();
        } else {
            isRunning = false;
            document.getElementById('mainBtn').innerText = "LAUNCH RADAR";
            document.getElementById('mainBtn').className = "bg-yellow-600 text-black px-6 py-2 font-bold rounded text-xs";
            document.getElementById('systemStatus').innerText = "RADAR IDLE";
            clearTimeout(timer);
        }
    }
</script>
</body>
</html>
