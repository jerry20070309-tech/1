<!DOCTYPE html>
<html>
<head>
    <title>⚡ SNIPER V8.1.3 - PACKET ONLY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background: #050505; color: #0f0; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card { background: #0a0a0a; border: 1px solid #1a1a1a; transition: 0.2s; cursor: pointer; }
        .card:hover { border-color: #3b82f6; background: #0d0d0d; }
        .pinned { border: 2px solid #3b82f6 !important; background: #081221 !important; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #222; }
    </style>
</head>
<body class="flex h-screen text-[10px]">
    <div class="flex-1 flex flex-col p-3 overflow-hidden">
        <div class="bg-zinc-900/50 p-4 rounded-xl mb-3 border border-white/5">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-black text-blue-500 italic uppercase">⚡ Sniper V8.1.3 <span class="text-zinc-600 text-[10px] not-italic">Packet Sync</span></h1>
                <div class="flex gap-2">
                    <input type="text" id="searchInput" placeholder="SEARCH..." class="bg-black border border-zinc-800 px-3 py-1 rounded text-blue-400 outline-none w-28 uppercase">
                    <button id="sysBtn" onclick="toggleSystem()" class="bg-blue-600 text-white px-4 py-1 rounded font-black uppercase hover:bg-blue-500 transition">Start Radar</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 uppercase font-bold text-zinc-500">
                <p>當前模式：極簡封包同步 (每 3 秒僅 3 個全市場請求，不抓單幣 K 線)</p>
            </div>
        </div>
        <div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto pr-1"></div>
    </div>

    <div class="w-64 bg-black border-l border-zinc-900 p-3 flex flex-col">
        <div class="text-zinc-600 font-black mb-2 border-b border-zinc-800 pb-1 uppercase">Packet Engine</div>
        <div id="logs" class="flex-1 overflow-y-auto space-y-1 font-mono text-[9px]"></div>
    </div>

<script>
    let stats = {}, pinned = new Set(), isRunning = false;
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT'];

    function addLog(msg, color="text-zinc-500") {
        const div = document.createElement('div');
        div.className = `border-l border-zinc-800 pl-2 ${color}`;
        div.innerHTML = `[${new Date().toLocaleTimeString('zh-TW', {hour12:false})}] ${msg}`;
        document.getElementById('logs').prepend(div);
    }

    function render() {
        const list = document.getElementById('list');
        const keyword = document.getElementById('searchInput').value.toUpperCase();
        const results = Object.values(stats).filter(x => x.s && x.s.includes(keyword));
        list.innerHTML = results
            .sort((a,b) => (pinned.has(b.s) - pinned.has(a.has)) || (b.v24h - a.v24h))
            .slice(0, 24)
            .map(x => `
                <div class="card p-3 rounded-lg ${pinned.has(x.s) ? 'pinned' : ''}" onclick="togglePin('${x.s}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-white font-black text-xs">${x.s.replace('USDT','')}</div>
                            <div class="text-[9px] text-zinc-400">$${x.price.toFixed(4)}</div>
                        </div>
                        <div class="text-right">
                            <div class="${x.change >= 0 ? 'text-green-500' : 'text-red-500'} font-black text-[10px]">${x.change.toFixed(2)}%</div>
                            <div class="text-zinc-500 text-[8px]">VOL: ${(x.v24h/1e6).toFixed(2)}M</div>
                        </div>
                    </div>
                    <div class="mt-2 text-[8px] text-zinc-500">
                        SPREAD: ${(x.spread * 100).toFixed(3)}%
                    </div>
                </div>
            `).join('');
    }

    async function scan() {
        if(!isRunning) return;
        if(window.scanTimer) clearTimeout(window.scanTimer);
        
        const startTime = Date.now();
        try {
            // 【核心修正】只抓這三個全市場大封包，不再有任何單幣 fetch
            const [pRes, tRes, bRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/bookTicker')
            ]);
            const [premiums, tickers, books] = await Promise.all([pRes.json(), tRes.json(), bRes.json()]);

            const newStats = {};
            // 處理價格與資金費率
            premiums.forEach(i => {
                if (EXCLUDE.includes(i.symbol) || !i.symbol.endsWith('USDT')) return;
                newStats[i.symbol] = { s: i.symbol, price: parseFloat(i.markPrice) };
            });

            // 處理 24h 成交量與漲跌
            tickers.forEach(i => {
                if (newStats[i.symbol]) {
                    newStats[i.symbol].v24h = parseFloat(i.quoteVolume);
                    newStats[i.symbol].change = parseFloat(i.priceChangePercent);
                }
            });

            // 處理買賣價差 (2k 防護核心)
            books.forEach(i => {
                if (newStats[i.symbol]) {
                    const spread = (parseFloat(i.askPrice) - parseFloat(i.bidPrice)) / parseFloat(i.bidPrice);
                    newStats[i.symbol].spread = spread;
                }
            });

            stats = newStats;
            render();
            addLog(`Packet Sync Success: 3 Requests`, "text-green-500");

        } catch (e) {
            addLog(`Sync Error: ${e.message}`, "text-red-500");
        }

        const elapsed = Date.now() - startTime;
        window.scanTimer = setTimeout(scan, Math.max(100, 3000 - elapsed));
    }

    async function toggleSystem() {
        if(isRunning) { isRunning = false; clearTimeout(window.scanTimer); document.getElementById('sysBtn').innerText = "Start Radar"; return; }
        isRunning = true;
        document.getElementById('sysBtn').innerText = "Stop Radar";
        scan();
    }

    function togglePin(s) { pinned.has(s) ? pinned.delete(s) : pinned.add(s); render(); }
</script>
</body>
</html>
