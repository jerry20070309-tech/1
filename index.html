<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>SNIPER V3.6.9 | ç±Œç¢¼çªç ´ç›£æ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #FFD700; font-family: 'Courier New', monospace; }
        .gold-border { border: 1px solid #FFD700; }
        .vp-break-card { border: 2px solid #a855f7; box-shadow: 0 0 20px #a855f7; background: #1e1b4b !important; }
        .log-panel { font-size: 10px; color: #666; font-family: monospace; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <header class="p-4 border-b border-yellow-900 bg-black flex justify-between items-center">
        <h1 class="text-2xl font-black text-yellow-500 tracking-tighter">âš¡ SNIPER V3.6.9</h1>
        <div class="flex gap-2">
            <input id="searchInput" type="text" placeholder="è¼¸å…¥å¹£å (å¦‚ BTC)" class="bg-zinc-900 text-xs px-2 py-1 focus:outline-none text-white border border-zinc-700 w-32">
            <button onclick="manualAdd()" class="bg-yellow-600 text-black px-4 py-1 font-bold rounded text-xs">ADD</button>
            <button onclick="toggleSystem()" id="mainBtn" class="bg-zinc-700 px-4 py-1 rounded text-white font-bold text-xs">START</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 p-4 overflow-y-auto bg-zinc-950">
            <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </main>
        
        <aside class="w-64 border-l border-zinc-800 p-4 log-panel overflow-y-auto bg-black">
            <div class="text-zinc-500 font-bold mb-2 uppercase tracking-widest">System Events</div>
            <div id="logs"></div>
        </aside>
    </div>

<script>
    // ä½ çš„é…ç½® (æ’é™¤ä½ ä¸æƒ³è¦çš„å¹£)
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','BNXUSDT'];
    let pinnedCoins = [], vpResults = {}, isRunning = false, timer = null;

    function addLog(msg) {
        const logs = document.getElementById('logs');
        const d = new Date();
        logs.innerHTML = `<div>[${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}] ${msg}</div>` + logs.innerHTML;
        if(logs.children.length > 20) logs.lastChild.remove();
    }

    // --- ç±Œç¢¼å¯†é›†å€çªç ´åµæ¸¬é‚è¼¯ (ä¿ç•™åŸæ¨£) ---
    function checkVolumeProfileBreakout(klines, currentPrice) {
        let maxHigh = 0; let highIdx = 0; 
        klines.forEach((k, i) => { 
            if (parseFloat(k[2]) > maxHigh) { maxHigh = parseFloat(k[2]); highIdx = i; } 
        }); 
        
        const rangeKlines = klines.slice(highIdx); 
        if (rangeKlines.length < 5) return { isBreakout: false, pocHigh: 0 }; 

        const lows = rangeKlines.map(k => parseFloat(k[3])); 
        const highs = rangeKlines.map(k => parseFloat(k[2])); 
        const minP = Math.min(...lows); 
        const maxP = Math.max(...highs); 
        const binSize = (maxP - minP) / 20; 
        
        const bins = new Array(20).fill(0); 
        rangeKlines.forEach(k => { 
            const vol = parseFloat(k[5]); 
            const avgP = (parseFloat(k[2]) + parseFloat(k[3])) / 2; 
            const binIdx = Math.min(19, Math.floor((avgP - minP) / binSize)); 
            bins[binIdx] += vol; 
        }); 

        const maxVolBinIdx = bins.indexOf(Math.max(...bins)); 
        const pocPrice = minP + (maxVolBinIdx * binSize); 
        const pocHigh = pocPrice + binSize; 
        
        const isBreakout = currentPrice > pocHigh; 
        return { isBreakout, pocHigh }; 
    }

    async function updateData() {
        if (pinnedCoins.length === 0) return;
        addLog("æ­£åœ¨æƒæå¯†é›†å€...");
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
            const allData = await res.json();

            for (const s of pinnedCoins) {
                const kRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=100`);
                const klines = await kRes.json();
                const priceData = allData.find(c => c.symbol === s);
                
                if (priceData) {
                    const price = parseFloat(priceData.markPrice);
                    vpResults[s] = checkVolumeProfileBreakout(klines, price);
                }
            }
            render(allData);
        } catch (e) { addLog("API æŠ“å–éŒ¯èª¤"); console.error(e); }
    }

    function render(allData) {
        const container = document.getElementById('dashboard');
        container.innerHTML = '';
        pinnedCoins.forEach(s => {
            const data = allData.find(c => c.symbol === s);
            if (!data) return;
            const vp = vpResults[s] || { isBreakout: false, pocHigh: 0 };
            const card = document.createElement('div');
            
            card.className = `p-4 bg-zinc-900 rounded ${vp.isBreakout ? 'vp-break-card' : 'gold-border'}`;
            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-black text-white">${s.replace('USDT','')}</h2>
                    <button onclick="removeCoin('${s}')" class="text-zinc-500 hover:text-white">âŒ</button>
                </div>
                <div class="space-y-1 text-xs">
                    <p class="text-zinc-400">ç•¶å‰åƒ¹æ ¼: <span class="text-white font-mono">${parseFloat(data.markPrice).toFixed(4)}</span></p>
                    <p class="text-zinc-400">å¯†é›†å€é ‚: <span class="text-yellow-500 font-mono">${vp.pocHigh ? vp.pocHigh.toFixed(4) : 'è¨ˆç®—ä¸­'}</span></p>
                    <div class="mt-4 pt-2 border-t border-zinc-800 font-bold ${vp.isBreakout ? 'text-purple-400' : 'text-zinc-500'}">
                        ç‹€æ…‹: ${vp.isBreakout ? 'ğŸš€ BREAKOUT (çªç ´)' : 'â˜ï¸ CONSOLIDATION'}
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function toggleSystem() {
        isRunning = !isRunning;
        const btn = document.getElementById('mainBtn');
        if (isRunning) { 
            btn.innerText = "STOP"; 
            btn.className = "bg-red-900 px-4 py-1 rounded text-white font-bold text-xs"; 
            addLog("ç³»çµ±å•Ÿå‹•");
            loop(); 
        } else { 
            btn.innerText = "START"; 
            btn.className = "bg-zinc-700 px-4 py-1 rounded text-white font-bold text-xs"; 
            addLog("ç³»çµ±åœæ­¢");
            clearTimeout(timer); 
        }
    }

    async function loop() { 
        if (!isRunning) return; 
        await updateData(); 
        timer = setTimeout(loop, 5000); 
    }

    function manualAdd() {
        const input = document.getElementById('searchInput');
        let s = input.value.toUpperCase().trim();
        if (!s) return; 
        if (!s.endsWith('USDT')) s += 'USDT';
        if (EXCLUDE.includes(s)) { alert("æ­¤å¹£å·²è¢«éæ¿¾"); return; }
        if (!pinnedCoins.includes(s)) { 
            pinnedCoins.push(s); 
            addLog(`å·²æ–°å¢: ${s}`);
            if(isRunning) updateData(); else fetch('https://fapi.binance.com/fapi/v1/premiumIndex').then(res=>res.json()).then(data=>render(data));
        }
        input.value = '';
    }

    function removeCoin(s) { 
        pinnedCoins = pinnedCoins.filter(c => c !== s); 
        addLog(`å·²ç§»é™¤: ${s}`);
        // ä¿®æ­£é€™è£¡ï¼Œå‚³å…¥ç•¶å‰çš„è³‡æ–™ç‹€æ…‹è€Œéç©ºé™£åˆ—
        fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            .then(res => res.json())
            .then(data => render(data)); 
    }
</script>
</body>
</html>
