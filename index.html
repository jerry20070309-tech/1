<!DOCTYPE html>
<html>
<head>
    <title>‚ö° SNIPER V8.1.4 - STRATEGY RESTORED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background: #050505; color: #0f0; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card { background: #0a0a0a; border: 1px solid #1a1a1a; transition: 0.2s; cursor: pointer; position: relative; }
        .card:hover { border-color: #3b82f6; background: #0d0d0d; }
        .poc-break { border-left: 4px solid #22c55e !important; }
        .ma-squeeze { border-right: 4px solid #eab308 !important; }
        .pinned { border: 2px solid #3b82f6 !important; background: #081221 !important; }
        .tag { font-size: 8px; padding: 1px 3px; font-weight: 900; border-radius: 2px; text-transform: uppercase; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .surge-pulse { animation: pulse-red 1s infinite; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #222; }
    </style>
</head>
<body class="flex h-screen text-[10px]">
    <div class="flex-1 flex flex-col p-3 overflow-hidden">
        <div class="bg-zinc-900/50 p-4 rounded-xl mb-3 border border-white/5">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-black text-blue-500 italic uppercase">‚ö° Sniper V8.1.4 <span class="text-zinc-600 text-[10px] not-italic">Strategy Back</span></h1>
                <div class="flex gap-2">
                    <input type="text" id="searchInput" placeholder="SEARCH..." class="bg-black border border-zinc-800 px-3 py-1 rounded text-blue-400 outline-none w-28 uppercase">
                    <button id="sysBtn" onclick="toggleSystem()" class="bg-blue-600 text-white px-4 py-1 rounded font-black uppercase hover:bg-blue-500 transition">Start Radar</button>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-4 uppercase font-bold">
                <div class="space-y-1">
                    <div class="flex justify-between text-red-500"><span>üìâ Slope</span><span id="v_slp">-15%</span></div>
                    <input type="range" id="i_slp" min="-100" max="0" value="-15" class="w-full h-1 bg-zinc-800 appearance-none rounded cursor-pointer">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-yellow-500"><span>üíØ Vacuum</span><span id="v_drv">90</span></div>
                    <input type="range" id="i_drv" min="0" max="100" value="90" class="w-full h-1 bg-zinc-800 appearance-none rounded cursor-pointer">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-green-500"><span>üéØ POC Gap</span><span id="v_poc">0.5%</span></div>
                    <input type="range" id="i_poc" min="0" max="50" value="5" class="w-full h-1 bg-zinc-800 appearance-none rounded cursor-pointer">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-orange-400"><span>üåÄ MA SQZ</span><span id="v_sqz">1.2%</span></div>
                    <input type="range" id="i_sqz" min="0" max="50" value="12" class="w-full h-1 bg-zinc-800 appearance-none rounded cursor-pointer">
                </div>
            </div>
        </div>
        <div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto pr-1"></div>
    </div>

    <div class="w-64 bg-black border-l border-zinc-900 p-3 flex flex-col">
        <div class="text-zinc-600 font-black mb-2 border-b border-zinc-800 pb-1 uppercase">Smart Sync Engine</div>
        <div id="logs" class="flex-1 overflow-y-auto space-y-1 font-mono text-[9px]"></div>
    </div>

<script>
    let stats = {}, pinned = new Set(), isRunning = false, symbols = [];
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT'];
    let FILTER = { SLP: -0.15, DRV: 90, POC: 0.005, SQZ: 0.012 };

    function addLog(msg, color="text-zinc-500") {
        const div = document.createElement('div');
        div.className = `border-l border-zinc-800 pl-2 ${color}`;
        div.innerHTML = `[${new Date().toLocaleTimeString('zh-TW', {hour12:false})}] ${msg}`;
        document.getElementById('logs').prepend(div);
    }

    // Ê†∏ÂøÉÈÅãÁÆóÂáΩÊï∏ÂõûÊ≠∏
    function calcMA(data, period) { return data.length < period ? 0 : data.slice(-period).reduce((a, b) => a + b, 0) / period; }
    function calculateScore(d) {
        if (d < 1000) return Math.round((d / 1000) * 20);
        if (d < 5000) return Math.round(20 + ((d - 1000) / 4000) * 40);
        return Math.round(60 + Math.min(40, (d - 5000) / 5000));
    }
    function calcPOC(klines) {
        let minP = Math.min(...klines.map(k => parseFloat(k[3])));
        let maxP = Math.max(...klines.map(k => parseFloat(k[2])));
        let bins = new Array(20).fill(0);
        klines.forEach(k => {
            let p = (parseFloat(k[2]) + parseFloat(k[3])) / 2;
            let v = parseFloat(k[5]);
            let idx = Math.floor(((p - minP) / (maxP - minP || 1)) * 19);
            bins[idx] += v;
        });
        return minP + (bins.indexOf(Math.max(...bins)) * ((maxP - minP) / 20));
    }

    async function scan() {
        if(!isRunning) return;
        if(window.scanTimer) clearTimeout(window.scanTimer);
        const startTime = Date.now();

        try {
            // 1. ÊäìÂèñ‰∏âÂ§ßÂÖ®Â∏ÇÂ†¥Â∞ÅÂåÖ
            const [pRes, tRes, bRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/bookTicker')
            ]);
            const [premiums, tickers, books] = await Promise.all([pRes.json(), tRes.json(), bRes.json()]);

            const marketMap = {};
            premiums.forEach(i => marketMap[i.symbol] = { price: parseFloat(i.markPrice) });
            tickers.forEach(i => { if(marketMap[i.symbol]) marketMap[i.symbol].v24h = parseFloat(i.quoteVolume); });
            books.forEach(i => { if(marketMap[i.symbol]) marketMap[i.symbol].spread = (parseFloat(i.askPrice)-parseFloat(i.bidPrice))/parseFloat(i.bidPrice); });

            // 2. Á≠ñÁï•È†êÈÅ∏ÔºöÂè™Â∞çÊµÅÂãïÊÄßÂ•ΩÁöÑÂπ£ÈÄ≤Ë°åÊ∑±Â±§Ë®àÁÆó
            const eligible = symbols.filter(s => {
                const g = marketMap[s];
                return g && g.v24h > 10000000 && g.spread < 0.002;
            });

            // ÊØèÊ¨°Ëº™Ë©¢ÈÅ∏ 15 ÂÄãÂπ£Êõ¥Êñ∞Á≠ñÁï•ÊåáÊ®ôÔºåÁ¢∫‰øù Network ‰∏çÊúÉÁàÜÁÇ∏
            const batch = eligible.slice(0, 15);
            symbols = [...symbols.filter(s => !batch.includes(s)), ...batch];

            await Promise.all(batch.map(async (s) => {
                try {
                    const [kRes, oRes] = await Promise.all([
                        fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=5m&limit=100`),
                        fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${s}`)
                    ]);
                    const [k, o] = await Promise.all([kRes.json(), oRes.json()]);
                    
                    const prices = k.map(x => parseFloat(x[4]));
                    const lastP = prices[prices.length-1];
                    const vNow = parseFloat(k[k.length-1][5]);
                    const vAvg = k.slice(-20).reduce((a,b)=>a+parseFloat(b[5]),0)/20;
                    
                    // DRV & MA & POC Á≠ñÁï•Ë®àÁÆó
                    const drvScore = calculateScore((Math.abs(lastP - prices[prices.length-2]) / (vNow || 1)) * 10000000);
                    const maSqz = (Math.max(calcMA(prices,7), calcMA(prices,25), calcMA(prices,99)) - Math.min(calcMA(prices,7), calcMA(prices,25), calcMA(prices,99))) / lastP;
                    const poc = calcPOC(k.slice(-50));
                    
                    const oi = parseFloat(o.openInterest);
                    if(!stats[s]) stats[s] = { oiHist: [], highPrice: lastP };
                    stats[s].oiHist.push(oi); if(stats[s].oiHist.length > 10) stats[s].oiHist.shift();

                    stats[s] = {
                        ...stats[s], s, price: lastP, v24h: marketMap[s].v24h, spread: marketMap[s].spread,
                        poc, drvScore, maSqz, oi,
                        isPocBrk: lastP > poc && vNow > vAvg * 1.5,
                        isSqz: maSqz < FILTER.SQZ,
                        totalScore: (lastP > poc ? 50 : 0) + (maSqz < FILTER.SQZ ? 30 : 0) + drvScore
                    };
                } catch(e) {}
            }));

            render();
            addLog(`Sync: 3 Bulk + ${batch.length*2} Strategy Tasks`, "text-blue-400");
        } catch (e) { addLog("Err: " + e.message, "text-red-500"); }

        window.scanTimer = setTimeout(scan, Math.max(100, 3000 - (Date.now() - startTime)));
    }

    function render() {
        const list = document.getElementById('list');
        const keyword = document.getElementById('searchInput').value.toUpperCase();
        const results = Object.values(stats).filter(x => x.s && x.s.includes(keyword));
        list.innerHTML = results
            .sort((a,b) => (pinned.has(b.s) - pinned.has(a.s)) || (b.totalScore - a.totalScore))
            .slice(0, 24)
            .map(x => `
                <div class="card p-3 rounded-lg ${x.isPocBrk ? 'poc-break' : ''} ${x.isSqz ? 'ma-squeeze' : ''} ${pinned.has(x.s) ? 'pinned' : ''}" onclick="togglePin('${x.s}')">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="text-white font-black text-xs">${x.s.replace('USDT','')} <span class="text-blue-500">#${Math.round(x.totalScore)}</span></div>
                            <div class="text-[9px] text-zinc-400 font-bold">$${x.price.toFixed(x.price < 1 ? 5 : 3)}</div>
                        </div>
                        <div class="text-right text-[9px]">
                            <div class="text-yellow-500">DRV: ${x.drvScore}</div>
                            <div class="text-zinc-500">OI: ${(x.oi/1e6).toFixed(1)}M</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-1 mb-2 text-[8px] font-bold">
                        <div class="bg-zinc-900 p-1 rounded">POC: ${x.poc.toFixed(3)}</div>
                        <div class="bg-zinc-900 p-1 rounded">SQZ: ${(x.maSqz*100).toFixed(2)}%</div>
                    </div>
                    <div class="flex gap-1">
                        ${x.isPocBrk ? '<span class="tag bg-green-600 text-black">POC_BRK</span>' : ''}
                        ${x.isSqz ? '<span class="tag bg-orange-500 text-black">MA_SQZ</span>' : ''}
                    </div>
                </div>
            `).join('');
    }

    async function toggleSystem() {
        if(isRunning) { isRunning = false; clearTimeout(window.scanTimer); document.getElementById('sysBtn').innerText = "Start Radar"; return; }
        const res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
        const data = await res.json();
        symbols = data.symbols.filter(s => s.quoteAsset === 'USDT' && s.status === 'TRADING').map(s => s.symbol).filter(s => !EXCLUDE.includes(s));
        isRunning = true;
        document.getElementById('sysBtn').innerText = "Stop Radar";
        scan();
    }

    function togglePin(s) { pinned.has(s) ? pinned.delete(s) : pinned.add(s); render(); }
    
    // ÊªëÂ°äÊéßÂà∂ÂõûÊ≠∏
    const bind = (id, vid, key, div) => {
        document.getElementById(id).oninput = (e) => {
            const v = parseFloat(e.target.value);
            FILTER[key] = v / div;
            document.getElementById(vid).innerText = (key==='DRV'?v:v+'%');
        }
    };
    bind('i_slp', 'v_slp', 'SLP', 100); bind('i_drv', 'v_drv', 'DRV', 1);
    bind('i_poc', 'v_poc', 'POC', 1000); bind('i_sqz', 'v_sqz', 'SQZ', 1000);
</script>
</body>
</html>
