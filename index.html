<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>SNIPER V13.9.0 | æ‰¹é‡ 3S å®Œæ•´ç­–ç•¥ç‰ˆ</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
    body { background-color: #000; color: #FFD700; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
    .vp-break-card { border: 2px solid #a855f7; box-shadow: 0 0 20px #a855f7; background: #1e1b4b !important; }
    .gold-border { border: 1px solid #FFD700; }
    input[type=range] { accent-color: #FFD700; height: 4px; cursor: pointer; }
</style>
</head>
<body class="h-screen flex flex-col">

<header class="p-4 border-b border-yellow-900 bg-black flex justify-between items-center shrink-0">
    <h1 class="text-xl font-black text-yellow-500 italic">âš¡ SNIPER V13.9.0</h1>
    
    <div class="flex gap-4 bg-zinc-900 p-2 rounded border border-zinc-800 text-[9px] font-bold">
        <div class="flex flex-col"><span>ğŸ“‰ GAP (çœŸç©º) <span id="v_gap">1.5%</span></span><input type="range" id="p_gap" min="5" max="50" value="15" oninput="sync()"></div>
        <div class="flex flex-col"><span>âš¡ MOM (æŒå€‰) <span id="v_mom">0.8%</span></span><input type="range" id="p_mom" min="1" max="50" value="8" oninput="sync()"></div>
        <div class="flex flex-col"><span>ğŸŒ€ DEP (2Kæ·±åº¦) <span id="v_dep">2.0k</span></span><input type="range" id="p_dep" min="5" max="100" value="20" oninput="sync()"></div>
        <div class="flex flex-col"><span>ğŸš€ DRV (é‡èƒ½) <span id="v_drv">90</span></span><input type="range" id="p_drv" min="10" max="150" value="90" oninput="sync()"></div>
    </div>

    <div class="flex gap-2">
        <input id="searchInput" type="text" placeholder="è¼¸å…¥å¹£å" class="bg-zinc-800 text-xs px-2 py-1 text-white border border-zinc-700 w-24 outline-none uppercase">
        <button onclick="manualAdd()" class="bg-yellow-600 text-black px-4 py-1 font-bold rounded text-xs">ADD</button>
        <button onclick="toggleSystem()" id="mainBtn" class="bg-blue-600 px-4 py-1 rounded text-white font-bold text-xs">START</button>
    </div>
</header>

<div class="flex-1 flex overflow-hidden">
    <main class="flex-1 p-4 overflow-y-auto bg-zinc-950">
        <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>
    <aside class="w-64 border-l border-zinc-800 p-4 bg-black overflow-y-auto">
        <div class="text-zinc-500 font-bold mb-2 uppercase text-[9px]">Saturday Strategy Log</div>
        <div id="logs" class="text-[9px] text-zinc-600 font-mono space-y-1"></div>
    </aside>
</div>

<script>
let pinnedCoins = [], stats = {}, isRunning = false, timer = null;
let PARAMS = { GAP: 0.015, MOM: 0.008, DEP: 2000, DRV: 90 };

function sync() {
    const g = document.getElementById('p_gap').value, m = document.getElementById('p_mom').value, d = document.getElementById('p_dep').value, v = document.getElementById('p_drv').value;
    PARAMS.GAP = g/1000; PARAMS.MOM = m/1000; PARAMS.DEP = d * 100; PARAMS.DRV = v;
    document.getElementById('v_gap').innerText = (g/10).toFixed(1)+'%';
    document.getElementById('v_mom').innerText = (m/10).toFixed(1)+'%';
    document.getElementById('v_dep').innerText = (d/10).toFixed(1)+'k';
    document.getElementById('v_drv').innerText = v;
}

// [B] æ ¸å¿ƒç®—æ³•å±¤ï¼šåŸæœ¬ç¨‹å¼ä¸€çš„å®Œæ•´ Volume Profile é‚è¼¯
function checkVP(klines, currentPrice, depthData) {
    let maxHigh = 0; let highIdx = 0;
    klines.forEach((k, i) => { if (parseFloat(k[2]) > maxHigh) { maxHigh = parseFloat(k[2]); highIdx = i; } });
    const rangeKlines = klines.slice(highIdx);
    if (rangeKlines.length < 5) return { isBreak: false, pocPrice: 0, gap: 0 };

    const lows = rangeKlines.map(k => parseFloat(k[3])), highs = rangeKlines.map(k => parseFloat(k[2]));
    const minP = Math.min(...lows), maxP = Math.max(...highs);
    const binSize = (maxP - minP) / 20, bins = new Array(20).fill(0);

    rangeKlines.forEach(k => {
        const avgP = (parseFloat(k[2]) + parseFloat(k[3])) / 2;
        const binIdx = Math.min(19, Math.floor((avgP - minP) / binSize));
        bins[binIdx] += parseFloat(k[5]);
    });

    const pocPrice = minP + (bins.indexOf(Math.max(...bins)) * binSize);
    const gap = (currentPrice - pocPrice) / pocPrice;

    // [2K è¨‚å–®éæ¿¾]
    const asks = depthData ? depthData.asks.slice(0, 10).reduce((sum, [p, q]) => sum + (p * q), 0) : 0;
    
    // æœ€çµ‚åˆ¤å®šï¼šçªç ´ POC + çœŸç©ºå€æ»¿è¶³ + 2K æ·±åº¦æ»¿è¶³
    const isBreak = (gap > PARAMS.GAP) && (asks > PARAMS.DEP);
    return { isBreak, pocPrice, gap, asks };
}

// [C] æ•¸æ“šé€šè¨Šå±¤ï¼š3 ç§’æ‰¹é‡æŠ“å–ï¼Œä¸åˆ†é–‹ç´¢å–
async function updateData() {
    if (pinnedCoins.length === 0) return;
    try {
        const priceRes = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
        const priceData = await priceRes.json();

        // [æ‰¹é‡è«‹æ±‚æ ¸å¿ƒ]ï¼šä½¿ç”¨ Promise.all åŒæ­¥ç²å– K ç·šèˆ‡æ·±åº¦
        const results = await Promise.all(pinnedCoins.map(async (s) => {
            const [kRes, dRes] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=100`),
                fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${s}&limit=20`)
            ]);
            return { s, klines: await kRes.json(), depth: await dRes.json() };
        }));

        results.forEach(res => {
            const pInfo = priceData.find(p => p.symbol === res.s);
            if (pInfo) {
                const curPrice = parseFloat(pInfo.markPrice);
                stats[res.s] = { ...checkVP(res.klines, curPrice, res.depth), price: curPrice };
            }
        });
        render();
    } catch (e) { console.error("Batch Request Failed"); }
}

function render() {
    const container = document.getElementById('dashboard');
    container.innerHTML = Object.entries(stats).map(([s, st]) => `
        <div class="p-4 rounded ${st.isBreak ? 'vp-break-card' : 'gold-border'} bg-zinc-900">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-black text-white italic">${s.replace('USDT','')}</h2>
                <button onclick="removeCoin('${s}')" class="text-zinc-600 hover:text-red-500">âŒ</button>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span>POC GAP:</span><span class="${st.gap > PARAMS.GAP ? 'text-green-400 font-bold' : ''}">${(st.gap*100).toFixed(2)}%</span></div>
                <div class="flex justify-between text-blue-400"><span>ASK DEPTH:</span><span>$${(st.asks/1000).toFixed(1)}k</span></div>
                <div class="pt-2 mt-1 border-t border-zinc-800 text-zinc-500 flex justify-between">
                    <span>PRICE: $${st.price.toFixed(4)}</span>
                    <span>POC: $${st.pocPrice.toFixed(4)}</span>
                </div>
            </div>
        </div>
    `).join('');
}

function toggleSystem() {
    isRunning = !isRunning;
    const btn = document.getElementById('mainBtn');
    btn.innerText = isRunning ? "STOP" : "START";
    btn.className = isRunning ? "bg-red-900 px-4 py-1 rounded text-white font-bold text-xs" : "bg-blue-600 px-4 py-1 rounded text-white font-bold text-xs";
    if (isRunning) loop(); else clearTimeout(timer);
}

async function loop() {
    if (isRunning) { await updateData(); timer = setTimeout(loop, 3000); }
}

function manualAdd() {
    let s = document.getElementById('searchInput').value.toUpperCase().trim();
    if (!s) return; if (!s.endsWith('USDT')) s += 'USDT';
    if (!pinnedCoins.includes(s)) { pinnedCoins.push(s); updateData(); }
    document.getElementById('searchInput').value = '';
}

function removeCoin(s) { pinnedCoins = pinnedCoins.filter(c => c !== s); delete stats[s]; render(); }
</script>
</body>
</html>
