<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>SNIPER V3.6.8 | ç±Œç¢¼çªç ´ç›£æ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #FFD700; font-family: 'Courier New', monospace; }
        .gold-border { border: 1px solid #FFD700; }
        .hunt-card { border: 2px solid #ff0000; box-shadow: 0 0 20px #ff0000; animation: blink 0.8s infinite; }
        .vp-break-card { border: 2px solid #a855f7; box-shadow: 0 0 20px #a855f7; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="h-screen flex flex-col">
    <header class="p-4 border-b border-yellow-900 bg-black flex justify-between items-center">
        <h1 class="text-2xl font-black text-yellow-500 tracking-tighter">âš¡ SNIPER V3.6.8</h1>
        <div class="flex gap-2">
            <input id="searchInput" type="text" placeholder="è¼¸å…¥å¹£å (å¦‚ BTC)" class="bg-zinc-900 text-xs px-2 py-1 focus:outline-none text-white border border-zinc-700">
            <button onclick="manualAdd()" class="bg-yellow-600 text-black px-4 py-1 font-bold rounded">ADD</button>
            <button onclick="toggleSystem()" id="mainBtn" class="bg-zinc-700 px-4 py-1 rounded text-white font-bold">START</button>
        </div>
    </header>

    <main class="flex-1 p-4 overflow-y-auto bg-zinc-950">
        <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </main>

<script>
    // ä½ çš„é…ç½®
    const CONFIG = {
        PO_USER: "Gkhqyhobnxzjfwgvaiyp347m1jkhn4", 
        PO_TOKEN: "acyoe3sz15x4n91r1349fdcau7x6pw"
    };

    let pinnedCoins = [], baseOI = {}, oiHistory = {}, vpResults = {}, isRunning = false, timer = null;

    // --- ç±Œç¢¼å¯†é›†å€çªç ´åµæ¸¬é‚è¼¯ (å®Œå…¨ç…§ä½ åœ–ç‰‡å¯«å…¥) ---
    function checkVolumeProfileBreakout(klines, currentPrice) {
        let maxHigh = 0; let highIdx = 0; 
        klines.forEach((k, i) => { 
            if (parseFloat(k[2]) > maxHigh) { maxHigh = parseFloat(k[2]); highIdx = i; } 
        }); // 1. æ‰¾åˆ°æœ€é«˜é»ä½œç‚ºèµ·å§‹ (å™´ç™¼é«˜é»)
        
        const rangeKlines = klines.slice(highIdx); // å¾é«˜é»åˆ°ç¾åœ¨çš„ K ç·š
        if (rangeKlines.length < 5) return { isBreakout: false, pocHigh: 0 }; 

        const lows = rangeKlines.map(k => parseFloat(k[3])); 
        const highs = rangeKlines.map(k => parseFloat(k[2])); 
        const minP = Math.min(...lows); 
        const maxP = Math.max(...highs); 
        const binSize = (maxP - minP) / 20; // 2. å»ºç«‹åƒ¹æ ¼åˆ†ç®± (Bins)
        
        const bins = new Array(20).fill(0); 
        rangeKlines.forEach(k => { 
            const vol = parseFloat(k[5]); // ä½¿ç”¨æˆäº¤é‡
            const avgP = (parseFloat(k[2]) + parseFloat(k[3])) / 2; 
            const binIdx = Math.min(19, Math.floor((avgP - minP) / binSize)); 
            bins[binIdx] += vol; 
        }); 

        const maxVolBinIdx = bins.indexOf(Math.max(...bins)); // 3. æ‰¾å‡ºæœ€å¤§æˆäº¤é‡å€é–“ (POC)
        const pocPrice = minP + (maxVolBinIdx * binSize); 
        const pocHigh = pocPrice + binSize; // å¯†é›†å€é ‚éƒ¨
        
        const isBreakout = currentPrice > pocHigh; // 4. åˆ¤æ–·æ˜¯å¦çªç ´
        return { isBreakout, pocHigh }; 
    }

    async function updateData() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
            const allData = await res.json();

            for (const s of pinnedCoins) {
                // æŠ“å– K ç·šä»¥ä¾›ç±Œç¢¼åˆ†æ
                const kRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=100`);
                const klines = await kRes.json();
                const priceData = allData.find(c => c.symbol === s);
                
                if (priceData) {
                    const price = parseFloat(priceData.markPrice);
                    vpResults[s] = checkVolumeProfileBreakout(klines, price);
                }
            }
            render(allData);
        } catch (e) { console.error("æ•¸æ“šæŠ“å–å¤±æ•—", e); }
    }

    function render(allData) {
        const container = document.getElementById('dashboard');
        container.innerHTML = '';
        pinnedCoins.forEach(s => {
            const data = allData.find(c => c.symbol === s);
            const vp = vpResults[s] || { isBreakout: false };
            const card = document.createElement('div');
            
            // å¦‚æœçªç ´ç±Œç¢¼å€ï¼Œé¡¯ç¤ºç´«è‰²é‚Šæ¡†
            card.className = `p-4 bg-zinc-900 rounded ${vp.isBreakout ? 'vp-break-card' : 'gold-border'}`;
            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-2xl font-black text-white">${s.replace('USDT','')}</h2>
                    <button onclick="removeCoin('${s}')" class="text-zinc-500">âŒ</button>
                </div>
                <div class="text-sm">
                    <p class="text-zinc-400">åƒ¹æ ¼: <span class="text-white">${parseFloat(data.markPrice)}</span></p>
                    <p class="mt-2 font-bold ${vp.isBreakout ? 'text-purple-400' : 'text-zinc-500'}">
                        ç±Œç¢¼ç‹€æ…‹: ${vp.isBreakout ? 'ğŸš€ çªç ´å¯†é›†å€' : 'â˜ï¸ å€é–“å…§'}
                    </p>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // ç³»çµ±é–‹é—œèˆ‡è¼”åŠ©å‡½æ•¸
    function toggleSystem() {
        isRunning = !isRunning;
        const btn = document.getElementById('mainBtn');
        if (isRunning) { btn.innerText = "STOP"; btn.className = "bg-red-900 px-4 py-1 rounded text-white font-bold"; loop(); }
        else { btn.innerText = "START"; btn.className = "bg-zinc-700 px-4 py-1 rounded text-white font-bold"; clearTimeout(timer); }
    }
    async function loop() { if (!isRunning) return; await updateData(); timer = setTimeout(loop, 5000); }
    function manualAdd() {
        const input = document.getElementById('searchInput');
        let s = input.value.toUpperCase().trim();
        if (!s) return; if (!s.endsWith('USDT')) s += 'USDT';
        if (!pinnedCoins.includes(s)) { pinnedCoins.push(s); updateData(); }
        input.value = '';
    }
    function removeCoin(s) { pinnedCoins = pinnedCoins.filter(c => c !== s); render([]); }
</script>
</body>
</html>
