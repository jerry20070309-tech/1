<script>
    const CONFIG = { EXCLUDE: ['BTCUSDT','ETHUSDT'], COOLDOWN: 180000 };
    let stats = {}, pinned = new Set(), isRunning = false;
    let priceSnapshots = {}, lastPushTime = {}, lastSnapMin = -1;
    let FILTER = { SQZ: 0.012, POC: 0.011, SLP: -0.015, DRV: 90, MOM: 0.008 };
    
    // [核心] WebSocket 資源池
    let tradeCounter = {}, activeWS = new Map();

    function initTradeWS(symbol) {
        if (activeWS.has(symbol)) return;
        try {
            const ws = new WebSocket(`wss://fapi.binance.com/ws/${symbol.toLowerCase()}@aggTrade`);
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                // 收到封包直接累加
                tradeCounter[symbol] = (tradeCounter[symbol] || 0) + 1;
            };
            ws.onclose = () => activeWS.delete(symbol);
            ws.onerror = () => activeWS.delete(symbol);
            activeWS.set(symbol, ws);
        } catch(e) { console.error(`WS Error: ${symbol}`); }
    }

    // 快捷鍵回歸
    function applyPreset(day) {
        const presets = {
            'Sat': { sqz: 8, poc: 5, slp: 5, drv: 110, mom: 5 }, 
            'Mon': { sqz: 15, poc: 12, slp: 20, drv: 85, mom: 15 },
            'Custom': { sqz: 12, poc: 11, slp: 15, drv: 90, mom: 8 }
        };
        const p = presets[day];
        const keys = ['sqz','poc','slp','drv','mom'];
        ['i_sqz','i_poc','i_slp','i_drv','i_mom'].forEach((id, i) => {
            document.getElementById(id).value = p[keys[i]];
            document.getElementById(id).dispatchEvent(new Event('input'));
        });
    }

    async function scan() {
        if(!isRunning) return;
        try {
            const [tRes, pRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'), 
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            const tickers = await tRes.json();
            const now = new Date();

            // 5M 同步邏輯
            if (now.getMinutes() % 5 === 0 && now.getMinutes() !== lastSnapMin) {
                lastSnapMin = now.getMinutes();
                tickers.forEach(t => priceSnapshots[t.symbol] = parseFloat(t.lastPrice));
            }

            // 1. 預處理排序，找出前 24 名
            const topCandidates = tickers
                .filter(t => t.symbol.endsWith('USDT') && !CONFIG.EXCLUDE.includes(t.symbol))
                .map(t => ({
                    s: t.symbol,
                    pc: Math.abs(parseFloat(t.priceChangePercent))
                }))
                .sort((a, b) => b.pc - a.pc)
                .slice(0, 24)
                .map(x => x.s);

            tickers.forEach(t => {
                const s = t.symbol; if (!s.endsWith('USDT') || CONFIG.EXCLUDE.includes(s)) return;
                
                // --- [自動連線邏輯] ---
                // 如果是熱門幣、或是你 Pin 住的幣，立刻啟動 WebSocket
                if (topCandidates.includes(s) || pinned.has(s)) {
                    initTradeWS(s);
                }

                const price = parseFloat(t.lastPrice), avgPrice = parseFloat(t.weightedAvgPrice);
                const high = parseFloat(t.highPrice), low = parseFloat(t.lowPrice);
                const dec = t.lastPrice.split('.')[1]?.length || 2;
                
                // 讀取並清除計數 (達成每 3 秒統計一次)
                const tc3s = tradeCounter[s] || 0; 
                tradeCounter[s] = 0; 

                const maSqz = (high - low) / avgPrice;
                const drvScore = Math.min(100, (Math.abs(parseFloat(t.priceChangePercent)) / (parseFloat(t.quoteVolume) / 1e8)) * 18);
                const v5m = priceSnapshots[s] ? (price - priceSnapshots[s]) / priceSnapshots[s] : 0;
                const gap = (price - avgPrice) / avgPrice;

                let score = 0;
                let meets = { slp: gap <= FILTER.SLP, sqz: maSqz <= FILTER.SQZ, poc: Math.abs(parseFloat(t.priceChangePercent))/100 >= FILTER.POC, drv: drvScore >= FILTER.DRV, mom: v5m >= FILTER.MOM };
                
                if (meets.sqz) score += 25;
                if (meets.drv) score += 25;
                if (meets.poc) score += 25;
                if (meets.mom) score += 25;

                let slMin = Math.min(price * 0.995, Math.max(avgPrice, low));
                let tpPot = price * (1 + Math.max(0.015, maSqz * 2));

                stats[s] = { s, price, dec, maSqz, drvScore, score, gap, meets, tc: tc3s, v5m, tpPot, slMin, rrRatio: (tpPot - price) / (price - slMin || 0.0001) };

                if (score >= 75 && (!lastPushTime[s] || Date.now() - lastPushTime[s] > CONFIG.COOLDOWN)) {
                    lastPushTime[s] = Date.now();
                    addLog(s, v5m, score);
                }
            });
            render();
        } catch (e) { console.error("Scan Error:", e); }
        setTimeout(scan, 3000);
    }

    // render() 與 setupSliders() 與 V11.9.9 相同，確保搜尋與顯示正常
    // ...
</script>
