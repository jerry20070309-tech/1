<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ SNIPER V9.1 | æ•ˆèƒ½èˆ‡é–€æª»å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background: #050505; color: #FFD700; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card { background: #0a0a0a; border: 1px solid #1a1a1a; transition: 0.2s; cursor: pointer; position: relative; }
        .hunt-card { border: 2px solid #ff0000; box-shadow: 0 0 15px #ff0000; animation: blink 0.8s infinite; }
        .alert-card { border: 2px solid #ffa500; box-shadow: 0 0 10px #ffa500; }
        .poc-break { border-left: 4px solid #22c55e !important; }
        .ma-squeeze { border-right: 4px solid #eab308 !important; }
        .pinned { border: 2px solid #3b82f6 !important; background: #081221 !important; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #222; }
        .tag { font-size: 8px; padding: 1px 4px; font-weight: 900; border-radius: 2px; text-transform: uppercase; }
    </style>
</head>
<body class="h-screen flex flex-col text-[10px]">

    <header class="p-4 border-b border-yellow-900 bg-black flex justify-between items-center shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-black text-yellow-500 italic">âš¡ SNIPER V9.1</h1>
            <div class="flex gap-2 bg-zinc-900 p-1 rounded border border-zinc-700">
                <input id="searchInput" type="text" placeholder="æœå°‹å¹£å" class="bg-transparent text-xs px-2 focus:outline-none w-24 text-white">
                <button onclick="manualAdd()" class="bg-yellow-600 text-black px-2 py-1 font-bold rounded">ADD</button>
            </div>
        </div>
        <div class="flex gap-2 text-[9px] items-center mr-4">
            <span class="text-zinc-500">æµå‹•æ€§é–€æª»: > 5M USDT</span>
        </div>
        <div class="flex gap-2">
            <button id="upFilterBtn" onclick="toggleUpFilter()" class="bg-zinc-800 px-3 py-1 rounded text-zinc-400 font-bold border border-zinc-600">ğŸ“ˆ åƒ…çœ‹ä¸Šæ¼²</button>
            <button onclick="testPush()" class="bg-blue-900 px-3 py-1 rounded text-white font-bold border border-blue-400">ğŸ§ª æ¸¬è©¦æ¨æ’­</button>
            <button id="sysBtn" onclick="toggleSystem()" class="bg-blue-600 text-white px-6 py-1 rounded font-black">START RADAR</button>
        </div>
    </header>

    <div class="bg-zinc-900/50 p-3 border-b border-white/5 grid grid-cols-4 gap-4 items-center uppercase font-bold text-zinc-400">
        <div class="space-y-1">
            <div class="flex justify-between text-yellow-500"><span>ğŸŒ€ SQZ (æ“ å£“)</span><span id="v_sqz">1.2%</span></div>
            <input type="range" id="i_sqz" min="1" max="50" value="12" class="w-full h-1 bg-zinc-800 appearance-none rounded">
        </div>
        <div class="space-y-1">
            <div class="flex justify-between text-green-500"><span>ğŸ¯ POC (çªç ´)</span><span id="v_poc">0.5%</span></div>
            <input type="range" id="i_poc" min="0" max="20" value="5" class="w-full h-1 bg-zinc-800 appearance-none rounded">
        </div>
        <div class="space-y-1">
            <div class="flex justify-between text-red-500"><span>ğŸ“‰ DRV (çœŸç©º)</span><span id="v_drv">90</span></div>
            <input type="range" id="i_drv" min="10" max="150" value="90" class="w-full h-1 bg-zinc-800 appearance-none rounded">
        </div>
        <div class="flex justify-between items-center text-[9px] bg-black/40 p-2 rounded">
            <div class="text-orange-400">SL: -2.0% / TP: +5.0%</div>
            <div id="klineStatus" class="text-white ml-2 text-right">ç­‰å¾…å¾ªç’°...</div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 p-3 overflow-y-auto bg-black">
            <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
        </main>
        <aside class="w-72 border-l border-yellow-900 bg-zinc-950 flex flex-col shrink-0">
            <div class="p-3 border-b border-zinc-800 text-red-500 font-bold flex justify-between">
                <span>æˆ°é¬¥æ—¥èªŒ</span>
                <span id="timerDisplay" class="text-zinc-600">ONLINE</span>
            </div>
            <div id="logContainer" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
        </aside>
    </div>

<script>
    const CONFIG = {
        PO_USER: "Gkhqyhobnxzjfwgvaiyp347m1jkhn4", 
        PO_TOKEN: "acyoe3sz15x4n91r1349fdcau7x6pw", 
        EXCLUDE: ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT'],
        MIN_VOLUME: 5000000, // ğŸ”¥ æ ¸å¿ƒå„ªåŒ–ï¼šæˆäº¤é‡å°æ–¼ 500 è¬çš„ä¸é¡¯ç¤º
        COOLDOWN: 300000
    };

    let stats = {}, pinned = new Set(), isRunning = false, isUpOnly = false;
    let baseOI = {}, priceSnapshots = {}, lastPushTime = {}, lastSnapMin = -1;
    let FILTER = { SQZ: 0.012, POC: 0.005, DRV: 90 };

    async function sendPush(title, message, priority = 0) {
        const params = new URLSearchParams({ token: CONFIG.PO_TOKEN, user: CONFIG.PO_USER, title, message, priority, sound: "classical" });
        try { await fetch('https://api.pushover.net/1/messages.json', { method: 'POST', body: params }); } catch(e) {}
    }

    async function scan() {
        if(!isRunning) return;
        try {
            // ğŸ”¥ æ•ˆèƒ½å„ªåŒ–ï¼šç§»é™¤å–®ç¨ K ç·šè«‹æ±‚ï¼Œåƒ…ä½¿ç”¨ 24h ç¶œåˆå¤§å°åŒ…
            const [tRes, bRes, pRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/bookTicker'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            
            const [tickers, books, premiums] = await Promise.all([tRes.json(), bRes.json(), pRes.json()]);
            const bookMap = Object.fromEntries(books.map(b => [b.symbol, b]));
            const premiumMap = Object.fromEntries(premiums.map(p => [p.symbol, p]));

            const now = new Date();
            // 5åˆ†é˜å¿«ç…§é‚è¼¯
            if (now.getMinutes() % 5 === 0 && now.getMinutes() !== lastSnapMin) {
                lastSnapMin = now.getMinutes();
                tickers.forEach(t => { 
                    priceSnapshots[t.symbol] = { p: parseFloat(t.lastPrice), isUp: !priceSnapshots[t.symbol] || parseFloat(t.lastPrice) >= priceSnapshots[t.symbol].p }; 
                });
                document.getElementById('klineStatus').innerText = `${now.getHours()}:${now.getMinutes()} å°é½Š`;
            }

            const newStats = {};
            tickers.forEach(t => {
                const s = t.symbol;
                const vol = parseFloat(t.quoteVolume);
                
                // ğŸ”¥ é‚è¼¯ç¯©é¸ 1: åƒ…çœ‹ USDT äº¤æ˜“å°ä¸¦æ’é™¤ä¸»æµå¹£
                if (!s.endsWith('USDT') || CONFIG.EXCLUDE.includes(s)) return;
                
                // ğŸ”¥ é‚è¼¯ç¯©é¸ 2: æ’é™¤æˆäº¤é‡éä½çš„å™ªéŸ³å¹£ (é™¤éè¢« Pins)
                if (vol < CONFIG.MIN_VOLUME && !pinned.has(s)) return;

                const price = parseFloat(t.lastPrice);
                const vAvg = parseFloat(t.weightedAvgPrice);
                const fund = parseFloat(premiumMap[s]?.lastFundingRate || 0);
                
                // æŒ‡æ¨™é‹ç®—
                const maSqz = (parseFloat(t.highPrice) - parseFloat(t.lowPrice)) / vAvg;
                const drvScore = Math.min(100, (Math.abs(parseFloat(t.priceChangePercent)) / (vol / 1e8)) * 15);
                const isSqz = maSqz < FILTER.SQZ;
                const isPocBrk = price > vAvg * (1 + FILTER.POC);
                
                newStats[s] = {
                    s, price, change: parseFloat(t.priceChangePercent), fund, vol,
                    maSqz, drvScore, isSqz, isPocBrk,
                    isUp: priceSnapshots[s]?.isUp ?? true,
                    spread: bookMap[s] ? (parseFloat(bookMap[s].askPrice) - parseFloat(bookMap[s].bidPrice))/price : 0,
                    score: (isSqz?30:0) + (isPocBrk?40:0) + (fund < -0.01?30:0)
                };

                // çµæ®ºæ¨æ’­åˆ¤å®š
                if (fund < -0.02 && drvScore > FILTER.DRV && vol > 10000000) {
                    const pushKey = `${s}_hunt`;
                    if (!lastPushTime[pushKey] || Date.now() - lastPushTime[pushKey] > CONFIG.COOLDOWN) {
                        sendPush(`ğŸ”¥ çµæ®º: ${s}`, `è²»ç‡: ${(fund*100).toFixed(4)}%\nçœŸç©º: ${drvScore.toFixed(0)}\né‡: ${(vol/1e6).toFixed(1)}M`, 1);
                        addLog(s, fund, drvScore, 2);
                        lastPushTime[pushKey] = Date.now();
                    }
                }
            });

            stats = newStats;
            render();
        } catch (e) { console.error("Scan Error:", e); }
        window.scanTimer = setTimeout(scan, 3000);
    }

    function render() {
        const dashboard = document.getElementById('dashboard');
        // ğŸ”¥ æ»‘å¡Šéæ¿¾é‚è¼¯ï¼šåŒæ­¥å¥—ç”¨ FILTER é–€æª»
        const list = Object.values(stats).filter(x => {
            if (isUpOnly && !x.isUp) return false;
            // éæ¿¾ï¼šå¿…é ˆç¬¦åˆå…¶ä¸­ä¸€é …æ¨™ç±¤æ‰æœƒåœ¨é¦–é é¡¯ç¤ºï¼Œæ¸›å°‘é›œè¨Š
            return x.isSqz || x.isPocBrk || x.drvScore > FILTER.DRV || pinned.has(x.s);
        });

        dashboard.innerHTML = list
            .sort((a,b) => (pinned.has(b.s) - pinned.has(a.s)) || (b.score - a.score))
            .slice(0, 24)
            .map(x => `
                <div class="card p-3 rounded-lg ${x.score > 60 ? 'hunt-card' : (x.score > 20 ? 'alert-card' : '')} ${x.isPocBrk ? 'poc-break' : ''} ${x.isSqz ? 'ma-squeeze' : ''} ${pinned.has(x.s) ? 'pinned' : ''}" onclick="togglePin('${x.s}')">
                    <div class="flex justify-between text-[8px] mb-1 font-bold">
                        <span class="${x.isUp ? 'text-green-500' : 'text-red-500'}">PRE-5K: ${x.isUp ? 'ğŸ“ˆ' : 'ğŸ“‰'}</span>
                        <span class="text-blue-500">#${x.drvScore.toFixed(0)} VACUUM</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-black text-white">${x.s.replace('USDT','')}</h2>
                        <div class="text-right">
                            <div class="${x.fund < 0 ? 'text-red-500' : 'text-green-500'} font-bold">${(x.fund*100).toFixed(4)}%</div>
                            <div class="text-zinc-500 text-[9px] font-bold">VOL: ${(x.vol/1e6).toFixed(1)}M</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-1 my-2 text-[8px] font-bold uppercase text-zinc-400">
                        <div class="bg-zinc-900 p-1 rounded">SQZ: ${(x.maSqz*100).toFixed(2)}%</div>
                        <div class="bg-zinc-900 p-1 rounded text-right">SPR: ${(x.spread*100).toFixed(3)}%</div>
                    </div>
                    <div class="flex gap-1 flex-wrap">
                        ${x.isPocBrk ? '<span class="tag bg-green-600 text-black">POC_BRK</span>' : ''}
                        ${x.isSqz ? '<span class="tag bg-orange-500 text-black">MA_SQZ</span>' : ''}
                        ${x.fund < -0.01 ? '<span class="tag bg-red-600 text-white">NEG_FUND</span>' : ''}
                    </div>
                </div>
            `).join('');
    }

    function addLog(s, f, d, lvl) {
        const container = document.getElementById('logContainer');
        const entry = document.createElement('div');
        entry.className = `p-2 bg-zinc-900 border-l-4 ${lvl===2?'border-red-600':'border-orange-500'} text-[9px] mb-1`;
        entry.innerHTML = `<b>${lvl===2?'ğŸ”¥':'ğŸ“¡'} ${s}</b> FND:${(f*100).toFixed(3)}% <span class="float-right text-zinc-600">${new Date().toLocaleTimeString()}</span>`;
        container.prepend(entry);
    }

    function toggleSystem() { isRunning = !isRunning; document.getElementById('sysBtn').innerText = isRunning ? "STOP RADAR" : "START RADAR"; if(isRunning) scan(); else clearTimeout(window.scanTimer); }
    function togglePin(s) { pinned.has(s) ? pinned.delete(s) : pinned.add(s); render(); }
    function toggleUpFilter() { isUpOnly = !isUpOnly; document.getElementById('upFilterBtn').classList.toggle('bg-green-900'); render(); }
    function manualAdd() { const input = document.getElementById('searchInput'); let s = input.value.toUpperCase().trim(); if(!s) return; if(!s.endsWith('USDT')) s+='USDT'; pinned.add(s); input.value=''; render(); }
    function testPush() { sendPush("Sniper V9.1 æ¸¬è©¦", "æˆäº¤é‡é–€æª» 5M å·²å•Ÿå‹•ï¼", 1); }

    // ğŸ”¥ æ»‘å¡Šä¿®æ­£ï¼šæ»‘å‹•å¾Œç«‹å³åŸ·è¡Œ render()ï¼Œç„¡éœ€ç­‰å¾…ä¸‹ä¸€æ¬¡æƒæ
    const bind = (id, vid, key, div) => {
        document.getElementById(id).oninput = (e) => {
            const v = parseFloat(e.target.value);
            FILTER[key] = v / div;
            document.getElementById(vid).innerText = (key==='DRV'?v:(v/10).toFixed(1)+'%');
            render(); 
        }
    };
    bind('i_sqz', 'v_sqz', 'SQZ', 1000);
    bind('i_poc', 'v_poc', 'POC', 1000);
    bind('i_drv', 'v_drv', 'DRV', 1);
</script>
</body>
</html>
