<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ SNIPER V13.2.0 | INDEPENDENT OI PACKET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background: #050505; color: #FFD700; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card { background: #0a0a0a; border: 1px solid #1a1a1a; transition: 0.3s; }
        .score-90 { border: 2px solid #ff0000; box-shadow: 0 0 20px #ff0000; background: #2a0000 !important; }
        .score-70 { border: 2px solid #a855f7; box-shadow: 0 0 15px #a855f7; background: #1e1b4b !important; }
        .log-item { border-left: 3px solid #ff0000; padding: 6px; margin-bottom: 5px; background: #111; font-size: 10px; color: #ff9999; }
    </style>
</head>
<body class="h-screen flex flex-col text-[10px]">

    <header class="p-4 border-b border-yellow-900 bg-black flex justify-between items-center shrink-0">
        <h1 class="text-2xl font-black text-yellow-500 italic">âš¡ SNIPER V13.2.0</h1>
        <div class="flex gap-2">
            <input id="addS" type="text" placeholder="æ‰‹å‹•æ·»åŠ " class="bg-zinc-900 border border-zinc-700 px-3 py-1 text-white text-xs rounded outline-none w-32">
            <button onclick="manualAdd()" class="bg-yellow-600 text-black px-4 py-1 font-bold rounded text-xs">ADD</button>
            <button id="sysBtn" onclick="toggleSystem()" class="bg-blue-600 text-white px-8 py-1 rounded font-black text-xs">START</button>
        </div>
    </header>

    <div class="bg-zinc-900 border-b border-yellow-900/30 p-3 grid grid-cols-4 gap-8 shrink-0 text-zinc-400 font-bold">
        <div class="flex flex-col"><span>ðŸ“‰ ENTRY: <span id="v_entry" class="text-red-500">-15%</span></span><input type="range" id="i_entry" min="5" max="50" value="15" oninput="updateParams()"></div>
        <div class="flex flex-col"><span>âš¡ MOM: <span id="v_mom" class="text-orange-500">0.8%</span></span><input type="range" id="i_mom" min="3" max="50" value="8" oninput="updateParams()"></div>
        <div class="flex flex-col"><span>ðŸŒ€ SQZ: <span id="v_sqz" class="text-blue-400">1.2%</span></span><input type="range" id="i_sqz" min="5" max="50" value="12" oninput="updateParams()"></div>
        <div class="flex flex-col"><span>ðŸš€ DRV: <span id="v_drv" class="text-green-400">90</span></span><input type="range" id="i_drv" min="10" max="150" value="90" oninput="updateParams()"></div>
    </div>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-64 border-r border-zinc-800 p-2 overflow-y-auto bg-black shrink-0">
            <div class="text-red-600 font-bold mb-2 uppercase text-[11px]">90+ Score Log</div>
            <div id="logs"></div>
        </aside>
        <div id="dashboard" class="flex-1 p-3 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </main>

<script>
    let stats = {}, isRunning = false;
    let pinnedCoins = []; // è¢«è¿½è¹¤çš„å¹£ç¨®æ¸…å–®
    let baseOI = {}, oiHistory = {}; 
    let PARAMS = { ENTRY: -0.15, MOM: 0.008, SQZ: 0.012, DRV: 90 };

    function updateParams() {
        const e = document.getElementById('i_entry').value, m = document.getElementById('i_mom').value, s = document.getElementById('i_sqz').value, d = document.getElementById('i_drv').value;
        PARAMS.ENTRY = -(e/100); PARAMS.MOM = m/1000; PARAMS.SQZ = s/1000; PARAMS.DRV = d;
        document.getElementById('v_entry').innerText = `-${e}%`; document.getElementById('v_mom').innerText = `${(m/10).toFixed(1)}%`;
        document.getElementById('v_sqz').innerText = `${(s/10).toFixed(1)}%`; document.getElementById('v_drv').innerText = d;
    }

    // æ­£ç¢ºçš„ OI æŠ“å–æŽ¥å£
    async function getOI(symbol) { 
        try { 
            const res = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`); 
            const data = await res.json(); 
            return parseFloat(data.openInterest); 
        } catch(e) { return null; } 
    }

    async function scan() {
        if(!isRunning) return;
        try {
            // å°åŒ… 1: åƒ¹æ ¼æ•¸æ“š
            const res24 = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const data24 = await res24.json();

            // æŒ‘é¸æ³¢å‹•æœ€å¼·çš„å‰ 20 åè‡ªå‹•åˆ—å…¥è¿½è¹¤ï¼Œæˆ–å¾ž pinnedCoins è¿½è¹¤
            const candidates = data24.filter(t => t.symbol.endsWith('USDT')).sort((a,b) => Math.abs(b.priceChangePercent) - Math.abs(a.priceChangePercent)).slice(0, 15);
            
            for (const t of candidates) {
                const s = t.symbol;
                if (!pinnedCoins.includes(s)) pinnedCoins.push(s);

                // å°åŒ… 2: OI ç¨ç«‹æŠ“å–ï¼ˆç„¡æ¢ä»¶è§¸ç™¼ï¼Œæ¯ 3 ç§’åŸ·è¡Œï¼‰
                const currentOI = await getOI(s);
                if (currentOI) {
                    if (!baseOI[s]) baseOI[s] = currentOI; // ç¬¬ä¸€æ¬¡æŠ“åˆ°æ™‚å­˜ç‚ºåŸºæº–é»ž
                    oiHistory[s] = currentOI;
                }

                const curPrice = parseFloat(t.lastPrice);
                const pocPrice = (parseFloat(t.highPrice) + parseFloat(t.lowPrice)) / 2;
                const growth = baseOI[s] ? (oiHistory[s] - baseOI[s]) / baseOI[s] : 0;

                let score = 0;
                if (curPrice > pocPrice) score += 40; 
                if (growth > PARAMS.MOM) score += 30; // OI æˆé•·åŠ åˆ†
                if (parseFloat(t.priceChangePercent) > 0) score += 30;

                stats[s] = { s, price: curPrice, score, poc: pocPrice, growth, tsl: pocPrice, ttp: curPrice * 1.05 };

                if (score >= 90) {
                    const log = document.getElementById('logs');
                    if (!document.getElementById(`log_${s}`)) {
                        log.innerHTML = `<div id="log_${s}" class="log-item"><b>${new Date().toLocaleTimeString()}</b> ${s}<br>Price: $${curPrice} | MOM: +${(growth*100).toFixed(2)}%</div>` + log.innerHTML;
                    }
                }
            }
            render();
        } catch (e) { console.error("Scan Error"); }
        setTimeout(scan, 3000);
    }

    function render() {
        const dashboard = document.getElementById('dashboard');
        const list = Object.values(stats).sort((a,b) => b.score - a.score);
        dashboard.innerHTML = list.map(x => `
            <div class="card p-4 rounded-lg ${x.score >= 90 ? 'score-90' : (x.score >= 70 ? 'score-70' : 'score-40')}">
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-2xl font-black text-white italic">${x.s.replace('USDT','')}</h2>
                    <span class="text-yellow-500 font-bold text-lg">â˜… ${x.score}</span>
                </div>
                <div class="grid grid-cols-2 gap-y-1 mb-3 text-[9px] font-bold uppercase">
                    <div class="text-zinc-400 text-[10px]">Price: <span class="text-white">$${x.price.toFixed(4)}</span></div>
                    <div class="text-green-400 text-right">Growth: +${(x.growth * 100).toFixed(2)}%</div>
                </div>
                <div class="border-t border-zinc-800 pt-2 flex justify-between font-mono text-[9px] font-black uppercase">
                    <div class="text-red-500">Stop: $${x.tsl.toFixed(4)}</div>
                    <div class="text-green-500">Target: $${x.ttp.toFixed(4)}</div>
                </div>
            </div>
        `).join('');
    }

    async function manualAdd() {
        let s = document.getElementById('addS').value.toUpperCase().trim();
        if(!s) return; if(!s.endsWith('USDT')) s += 'USDT';
        if(!pinnedCoins.includes(s)) pinnedCoins.push(s);
        const oi = await getOI(s); if(oi) { baseOI[s] = oi; oiHistory[s] = oi; }
        document.getElementById('addS').value = '';
    }

    function toggleSystem() { isRunning = !isRunning; document.getElementById('sysBtn').innerText = isRunning ? "STOP" : "START"; if(isRunning) scan(); }
</script>
</body>
</html>
